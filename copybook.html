<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字帖生成系统</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 添加FileSaver.js用于保存文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* 移动端触摸优化 */
        @media (max-width: 768px) {
            button, 
            .action-btn, 
            .nav-link, 
            .grid-type-option,
            .color-option,
            .upload-input {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* 防止双击缩放 */
            button, .action-btn {
                touch-action: manipulation;
            }
            
            /* 优化滚动体验 */
            .settings-panel, .copybook-preview {
                -webkit-overflow-scrolling: touch;
            }
            
            /* 修复iOS Safari上的按钮样式 */
            input[type="range"] {
                -webkit-appearance: none;
                background: transparent;
            }
            
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
            }
        }
        
        /* 更新设置面板样式，使其可滚动 */
        .settings-panel {
            width: 320px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: 85vh; /* 设置固定高度 */
            overflow-y: auto; /* 添加垂直滚动 */
            position: sticky;
            top: 20px;
            scrollbar-width: thin;
            scrollbar-color: #4a6fa5 #f0f0f0;
        }

        /* 自定义滚动条样式 */
        .settings-panel::-webkit-scrollbar {
            width: 6px;
        }

        .settings-panel::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }

        .settings-panel::-webkit-scrollbar-thumb {
            background: #4a6fa5;
            border-radius: 3px;
        }

        .settings-panel::-webkit-scrollbar-thumb:hover {
            background: #3a5a8a;
        }

        /* 调整字帖预览区域 */
        .copybook-preview {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            max-height: 85vh; /* 与左侧面板高度一致 */
            overflow-y: auto; /* 如果内容过多也可滚动 */
        }

        /* 导航栏样式 */
        .navbar {
            background-color: #4a90e2;
            padding: 12px 0;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            font-size: 18px;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-link.active {
            background-color: #2c6cb0;
        }
        
        .nav-link i {
            margin-right: 8px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* 字帖页面专用样式 */
        .copybook-container {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        
        .settings-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .settings-group h3 {
            color: #4a6fa5;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-group h3 i {
            font-size: 18px;
        }
        
        .grade-selection {
            margin-bottom: 20px;
        }
        
        .grade-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .grade-select:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        .upload-section {
            margin-top: 20px;
        }
        
        .upload-label {
            display: block;
            margin-bottom: 10px;
            color: #666;
            font-weight: 500;
        }
        
        .upload-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            margin-bottom: 10px;
        }
        
        .upload-input:hover {
            border-color: #4a6fa5;
        }
        
        .upload-input input {
            display: none;
        }
        
        .upload-help {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            display: block;
        }
        
        .grid-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .grid-type-option {
            text-align: center;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .grid-type-option:hover {
            border-color: #4a6fa5;
            background-color: #f0f7ff;
        }
        
        .grid-type-option.active {
            border-color: #4a6fa5;
            background-color: #4a6fa5;
            color: white;
        }
        
        .grid-type-preview {
            width: 40px;
            height: 40px;
            margin: 0 auto 8px;
            position: relative;
            border: 1px solid #999;
            border-radius: 2px;
        }
        
        .font-family-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .slider-container {
            margin-bottom: 15px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .slider-value {
            color: #4a6fa5;
            font-weight: bold;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4a6fa5;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.3s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.active {
            border-color: #333;
            transform: scale(1.1);
        }
        
        .custom-color {
            position: relative;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
            cursor: pointer;
        }
        
        .custom-color input {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .generate-btn {
            background-color: #4a6fa5;
            color: white;
        }
        
        .generate-btn:hover {
            background-color: #3a5a8a;
            transform: translateY(-2px);
        }
        
        .download-word-btn {
            background-color: #2b579a;
            color: white;
        }
        
        .download-word-btn:hover {
            background-color: #1e447e;
            transform: translateY(-2px);
        }
        
        .reset-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .reset-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .preview-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .preview-header h2 {
            color: #4a6fa5;
            margin-bottom: 5px;
        }
        
        .preview-header p {
            color: #666;
        }
        
        .preview-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .page-btn {
            background-color: #4a6fa5;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .page-btn:hover:not(:disabled) {
            background-color: #3a5a8a;
            transform: scale(1.1);
        }
        
        .page-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .page-info {
            font-weight: 500;
            color: #4a6fa5;
        }
        
        .copybook-content {
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            min-height: 1100px; /* 确保足够高度显示所有行 */
        }
        
        .grid-page {
            display: none;
            width: 100%;
            padding: 40px; /* 增加内边距 */
            box-sizing: border-box;
        }
        
        .grid-page.active {
            display: block;
        }
        
        /* 关键修复：使用固定尺寸的网格确保每个格子都是正方形 */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* 每行8个格子 */
            grid-template-rows: repeat(10, 1fr);   /* 每页10行 */
            gap: 1px; /* 格子间距 */
            width: 100%;
            height: 900px; /* 固定高度，确保正方形 */
            margin: 0 auto;
        }
        
        /* 确保每个格子都是真正的正方形 */
        .grid-cell {
            position: relative;
            border: 1px solid #ddd;
            width: 100%;
            height: 100%; /* 使用父容器的高度 */
            box-sizing: border-box;
            background-color: white;
            overflow: hidden;
        }
        
        .grid-cell .grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .grid-cell .grid-lines .line {
            position: absolute;
            background-color: #eee;
        }
        
        .grid-cell .grid-lines .center-vertical {
            width: 1px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .grid-cell .grid-lines .center-horizontal {
            height: 1px;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .grid-cell .grid-lines .diagonal-1 {
            width: 1px;
            height: 141%;
            left: 50%;
            top: -20%;
            transform: translateX(-50%) rotate(45deg);
        }
        
        .grid-cell .grid-lines .diagonal-2 {
            width: 1px;
            height: 141%;
            left: 50%;
            top: -20%;
            transform: translateX(-50%) rotate(-45deg);
        }
        
        .grid-cell .character {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 空单元格保持灰色背景 */
        .empty-cell {
            background-color: #f9f9f9 !important;
        }
        
        /* 非空单元格保持白色背景 */
        .grid-cell:not(.empty-cell) {
            background-color: white !important;
        }
        
        .preview-footer {
            text-align: center;
            margin-top: 20px;
            color: #888;
            font-size: 14px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        .loading-spinner i {
            font-size: 48px;
            color: #4a6fa5;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        @media (max-width: 1024px) {
            .copybook-container {
                flex-direction: column;
            }
            
            .settings-panel {
                width: 100%;
                position: static;
            }
            
            .grid-container {
                height: 700px; /* 调整高度适应屏幕 */
            }
        }
        
        @media (max-width: 768px) {
            .grid-type-selector {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            /* 移动端调整 */
            .grid-container {
                height: 600px; /* 移动端减小高度 */
            }
            
            .grid-cell .character {
                font-size: 24px;
            }
        }
        
        @media (max-width: 480px) {
            .grid-container {
                height: 500px;
            }
            
            .grid-cell .character {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>主页
                </a>
                <a href="copybook.html" class="nav-link active">
                    <i class="fas fa-pen-fancy"></i>字帖练习
                </a>
            </div>
        </nav>
        
        <header class="header">
            <h1>小学语文生字字帖生成系统</h1>
            <p class="subtitle">生成专业田字格/米字格字帖，支持打印和导出</p>
        </header>
        
        <!-- 错误和成功消息 -->
        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>
        
        <div class="copybook-container">
            <!-- 左侧设置面板 -->
            <div class="settings-panel">
                <div class="settings-group">
                    <h3><i class="fas fa-book"></i> 生字来源</h3>
                    
                    <div class="grade-selection">
                        <label>选择年级：</label>
                        <select id="grade-select" class="grade-select">
                            <option value="">请选择年级</option>
                            <option value="一年级上册">一年级上册</option>
                            <option value="一年级下册">一年级下册</option>
                            <option value="二年级上册">二年级上册</option>
                            <option value="二年级下册">二年级下册</option>
                            <option value="三年级上册">三年级上册</option>
                            <option value="三年级下册">三年级下册</option>
                            <option value="四年级上册">四年级上册</option>
                            <option value="四年级下册">四年级下册</option>
                            <option value="五年级上册">五年级上册</option>
                            <option value="五年级下册">五年级下册</option>
                            <option value="六年级上册">六年级上册</option>
                            <option value="六年级下册">六年级下册</option>
                        </select>
                    </div>
                    
                    <div class="upload-section">
                        <label class="upload-label">或上传Excel文件：</label>
                        <div class="upload-input" id="excel-upload">
                            <i class="fas fa-upload"></i>
                            <span>点击上传Excel文件</span>
                            <input type="file" id="excel-file" accept=".xlsx,.xls,.csv">
                        </div>
                        <small class="upload-help">Excel文件必须包含"生字"列</small>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-border-style"></i> 方格设置</h3>
                    <div class="grid-type-selector">
                        <div class="grid-type-option active" data-type="tian">
                            <div class="grid-type-preview">
                                <div class="grid-lines">
                                    <div class="line center-vertical"></div>
                                    <div class="line center-horizontal"></div>
                                </div>
                            </div>
                            <div>田字格</div>
                        </div>
                        <div class="grid-type-option" data-type="mi">
                            <div class="grid-type-preview">
                                <div class="grid-lines">
                                    <div class="line center-vertical"></div>
                                    <div class="line center-horizontal"></div>
                                    <div class="line diagonal-1"></div>
                                    <div class="line diagonal-2"></div>
                                </div>
                            </div>
                            <div>米字格</div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-font"></i> 字体设置</h3>
                    
                    <label>字体类型：</label>
                    <select id="font-family" class="font-family-select">
                        <option value="Ma Shan Zheng, cursive">毛笔字体</option>
                        <option value="KaiTi, serif">楷体</option>
                        <option value="SimSun, serif">宋体</option>
                        <option value="Microsoft YaHei, sans-serif">微软雅黑</option>
                    </select>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>字体大小：</span>
                            <span id="font-size-value" class="slider-value">36px</span>
                        </div>
                        <input type="range" id="font-size" class="slider" min="20" max="60" value="36">
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>字体粗细：</span>
                            <span id="font-weight-value" class="slider-value">400</span>
                        </div>
                        <input type="range" id="font-weight" class="slider" min="100" max="900" step="100" value="400">
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-palette"></i> 字体颜色</h3>
                    <div class="color-picker">
                        <div class="color-option active" style="background-color: #333333;" data-color="#333333"></div>
                        <div class="color-option" style="background-color: #4a6fa5;" data-color="#4a6fa5"></div>
                        <div class="color-option" style="background-color: #27ae60;" data-color="#27ae60"></div>
                        <div class="color-option" style="background-color: #e74c3c;" data-color="#e74c3c"></div>
                        <div class="color-option" style="background-color: #f39c12;" data-color="#f39c12"></div>
                        <div class="color-option" style="background-color: #8e44ad;" data-color="#8e44ad"></div>
                        <div class="color-option custom-color">
                            <input type="color" id="custom-color" value="#333333">
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="generate-btn" class="action-btn generate-btn">
                        <i class="fas fa-magic"></i> 生成字帖
                    </button>
                    <button id="download-word-btn" class="action-btn download-word-btn" disabled>
                        <i class="fas fa-file-word"></i> 下载Word
                    </button>
                    <button id="reset-btn" class="action-btn reset-btn">
                        <i class="fas fa-redo"></i> 重置设置
                    </button>
                </div>
            </div>
            
            <!-- 右侧字帖预览 -->
            <div class="copybook-preview">
                <div class="preview-header">
                    <h2 id="preview-title">字帖预览</h2>
                    <p id="character-count">请先生成字帖</p>
                </div>
                
                <div class="preview-controls">
                    <button id="prev-page-btn" class="page-btn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="page-info" class="page-info">第 <span id="current-page">1</span> 页 / 共 <span id="total-pages">1</span> 页</span>
                    <button id="next-page-btn" class="page-btn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <div id="copybook-content" class="copybook-content">
                    <div id="grid-pages">
                        <!-- 字帖页面会在这里动态生成 -->
                        <div class="grid-page active" id="page-1">
                            <!-- 网格容器会在这里动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="preview-footer">
                    <p>温馨提示：生成字帖后，您可以直接打印或下载为Word文件</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 加载动画 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner"></i>
            <p>正在生成字帖，请稍候...</p>
        </div>
    </div>
    
    <script>
    // 全局变量
    let currentCharacters = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentSettings = {
        gridType: 'tian',
        fontFamily: 'Ma Shan Zheng, cursive',
        fontSize: 36,
        fontWeight: 400,
        fontColor: '#333333',
        rowsPerPage: 10,  // 每页10行
        colsPerPage: 8    // 每行8个格子
    };

    // DOM元素
    const gradeSelect = document.getElementById('grade-select');
    const excelUpload = document.getElementById('excel-upload');
    const excelFileInput = document.getElementById('excel-file');
    const gridTypeOptions = document.querySelectorAll('.grid-type-option');
    const fontFamilySelect = document.getElementById('font-family');
    const fontSizeSlider = document.getElementById('font-size');
    const fontSizeValue = document.getElementById('font-size-value');
    const fontWeightSlider = document.getElementById('font-weight');
    const fontWeightValue = document.getElementById('font-weight-value');
    const colorOptions = document.querySelectorAll('.color-option:not(.custom-color)');
    const customColorInput = document.getElementById('custom-color');
    const generateBtn = document.getElementById('generate-btn');
    const downloadWordBtn = document.getElementById('download-word-btn');
    const resetBtn = document.getElementById('reset-btn');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    const currentPageSpan = document.getElementById('current-page');
    const totalPagesSpan = document.getElementById('total-pages');
    const gridPagesContainer = document.getElementById('grid-pages');
    const previewTitle = document.getElementById('preview-title');
    const characterCount = document.getElementById('character-count');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    // A4纸尺寸（毫米）
    const A4_WIDTH_MM = 210;
    const A4_HEIGHT_MM = 297;
    const A4_MARGIN_MM = 20; // 页边距
    const MM_TO_PX = 3.78; // 1毫米 ≈ 3.78像素

    // 计算实际可用尺寸（像素）
    const usableWidthPx = (A4_WIDTH_MM - A4_MARGIN_MM * 2) * MM_TO_PX;
    const usableHeightPx = (A4_HEIGHT_MM - A4_MARGIN_MM * 2) * MM_TO_PX;

    console.log(`A4可用尺寸: ${usableWidthPx.toFixed(0)}px × ${usableHeightPx.toFixed(0)}px`);

    // 初始化事件监听器
    function initEventListeners() {
        // 年级选择
        gradeSelect.addEventListener('change', function() {
            if (this.value) {
                clearExcelFile();
                loadCharactersFromJSON(this.value);
            }
        });
        
        // Excel文件上传
        excelUpload.addEventListener('click', function() {
            excelFileInput.click();
        });
        
        excelFileInput.addEventListener('change', function(e) {
            if (this.files.length > 0) {
                gradeSelect.value = '';
                loadCharactersFromExcel(this.files[0]);
            }
        });
        
        // 方格类型选择
        gridTypeOptions.forEach(option => {
            option.addEventListener('click', function() {
                gridTypeOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                currentSettings.gridType = this.dataset.type;
                updateCopybookPreview();
            });
        });
        
        // 字体设置
        fontFamilySelect.addEventListener('change', function() {
            currentSettings.fontFamily = this.value;
            updateCopybookPreview();
        });
        
        fontSizeSlider.addEventListener('input', function() {
            currentSettings.fontSize = parseInt(this.value);
            fontSizeValue.textContent = this.value + 'px';
            updateCopybookPreview();
        });
        
        fontWeightSlider.addEventListener('input', function() {
            currentSettings.fontWeight = parseInt(this.value);
            fontWeightValue.textContent = this.value;
            updateCopybookPreview();
        });
        
        // 颜色选择
        colorOptions.forEach(option => {
            option.addEventListener('click', function() {
                colorOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                currentSettings.fontColor = this.dataset.color;
                customColorInput.value = this.dataset.color;
                updateCopybookPreview();
            });
        });
        
        customColorInput.addEventListener('input', function() {
            currentSettings.fontColor = this.value;
            colorOptions.forEach(opt => opt.classList.remove('active'));
            updateCopybookPreview();
        });
        
        // 按钮事件
        generateBtn.addEventListener('click', generateCopybook);
        downloadWordBtn.addEventListener('click', downloadAsWord);
        resetBtn.addEventListener('click', resetSettings);
        prevPageBtn.addEventListener('click', goToPrevPage);
        nextPageBtn.addEventListener('click', goToNextPage);
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                goToPrevPage();
            } else if (e.key === 'ArrowRight') {
                goToNextPage();
            } else if (e.key === 'Enter' && e.ctrlKey) {
                generateCopybook();
            }
        });
    }

    // 从JSON加载生字数据
    async function loadCharactersFromJSON(grade) {
        showLoading();
        hideMessages();
        
        try {
            const response = await fetch('data.json');
            if (!response.ok) throw new Error('数据加载失败');
            
            const data = await response.json();
            const gradeData = data.find(item => item.grade === grade);
            
            if (gradeData && gradeData.characters) {
                // 确保读取所有生字
                currentCharacters = gradeData.characters.map(item => item.word);
                
                // 去重并过滤空值
                currentCharacters = [...new Set(currentCharacters.filter(char => char && char.trim()))];
                
                previewTitle.textContent = `${grade} 生字字帖`;
                showSuccess(`成功加载 ${currentCharacters.length} 个生字！`);
                
                // 检查实际读取的生字
                console.log(`从JSON读取的生字数量: ${currentCharacters.length}`);
                console.log('前10个生字:', currentCharacters.slice(0, 10));
                
                setTimeout(() => {
                    generateCopybook();
                }, 100);
            } else {
                throw new Error(`未找到${grade}的生字数据`);
            }
        } catch (error) {
            showError(error.message);
            currentCharacters = [];
        } finally {
            hideLoading();
        }
    }

    // 从Excel加载生字数据 - 修复版本
    async function loadCharactersFromExcel(file) {
        showLoading();
        hideMessages();
        
        try {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    console.log('Excel原始数据:', jsonData);
                    
                    // 查找"生字"列索引
                    let characterColumnIndex = -1;
                    const headers = jsonData[0] || [];
                    
                    for (let i = 0; i < headers.length; i++) {
                        const header = String(headers[i]).trim().toLowerCase();
                        if (header === '生字' || header === 'word' || header === '汉字' || header === '字符') {
                            characterColumnIndex = i;
                            break;
                        }
                    }
                    
                    if (characterColumnIndex === -1) {
                        // 尝试自动识别第一列
                        characterColumnIndex = 0;
                    }
                    
                    // 从第二行开始读取数据（跳过标题行）
                    let characters = [];
                    for (let rowIndex = 1; rowIndex < jsonData.length; rowIndex++) {
                        const row = jsonData[rowIndex] || [];
                        if (row[characterColumnIndex]) {
                            const char = String(row[characterColumnIndex]).trim();
                            if (char) {
                                characters.push(char);
                            }
                        }
                    }
                    
                    if (characters.length === 0) {
                        // 尝试另一种读取方式
                        const jsonData2 = XLSX.utils.sheet_to_json(firstSheet);
                        characters = [];
                        
                        for (let row of jsonData2) {
                            // 尝试所有可能的列名
                            for (let key in row) {
                                const value = String(row[key]).trim();
                                if (value && value.length <= 3) { // 生字通常是1-3个字符
                                    characters.push(value);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (characters.length === 0) {
                        throw new Error('无法从Excel文件中读取生字数据，请确保文件包含生字内容');
                    }
                    
                    // 去重并过滤空值
                    characters = [...new Set(characters.filter(char => char && char.trim()))];
                    
                    currentCharacters = characters;
                    previewTitle.textContent = `自定义生字字帖 (${file.name})`;
                    showSuccess(`成功读取 ${characters.length} 个生字`);
                    
                    console.log(`从Excel读取的生字数量: ${characters.length}`);
                    console.log('前10个生字:', characters.slice(0, 10));
                    
                    setTimeout(() => {
                        generateCopybook();
                    }, 100);
                    
                } catch (error) {
                    console.error('Excel处理错误:', error);
                    showError('Excel文件处理失败: ' + error.message);
                    currentCharacters = [];
                } finally {
                    hideLoading();
                }
            };
            
            reader.onerror = function() {
                showError('文件读取失败');
                hideLoading();
            };
            
            reader.readAsArrayBuffer(file);
        } catch (error) {
            console.error('文件读取错误:', error);
            showError('文件处理失败: ' + error.message);
            hideLoading();
        }
    }

    // 生成字帖 - 根据A4纸尺寸计算格子大小
    function generateCopybook() {
        if (currentCharacters.length === 0) {
            showError('请先选择年级或上传Excel文件');
            return;
        }
        
        console.log(`开始生成字帖，总生字数: ${currentCharacters.length}`);
        
        showLoading();
        
        try {
            const rowsPerPage = currentSettings.rowsPerPage; // 每页10行
            const colsPerRow = currentSettings.colsPerPage; // 每行8个格子
            
            // 计算总页数
            totalPages = Math.ceil(currentCharacters.length / rowsPerPage);
            
            console.log(`字帖配置: 每页${rowsPerPage}行, 每行${colsPerRow}格, 总页数: ${totalPages}`);
            
            // 清空现有页面
            gridPagesContainer.innerHTML = '';
            
            // 计算每个格子的尺寸，确保正方形且适应A4纸
            // 使用可用宽度的90%来确保有边距
            const containerWidth = usableWidthPx * 0.9;
            const containerHeight = usableHeightPx * 0.8;
            
            // 计算每个格子的最大可能尺寸
            const maxCellWidth = Math.floor(containerWidth / colsPerRow);
            const maxCellHeight = Math.floor(containerHeight / rowsPerPage);
            const cellSize = Math.min(maxCellWidth, maxCellHeight);
            
            console.log(`格子尺寸: ${cellSize}px, 容器: ${containerWidth}px × ${containerHeight}px`);
            
            // 生成所有页面
            for (let page = 1; page <= totalPages; page++) {
                const pageElement = document.createElement('div');
                pageElement.className = `grid-page ${page === 1 ? 'active' : ''}`;
                pageElement.id = `page-${page}`;
                pageElement.style.cssText = `
                    padding: 20px;
                    box-sizing: border-box;
                    width: 100%;
                    display: flex;
                    justify-content: center;
                    align-items: flex-start;
                    background-color: white;
                `;
                
                // 创建网格容器
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid-container';
                gridContainer.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(${colsPerRow}, ${cellSize}px);
                    grid-template-rows: repeat(${rowsPerPage}, ${cellSize}px);
                    gap: 1px;
                    width: ${cellSize * colsPerRow + (colsPerRow - 1)}px;
                    height: ${cellSize * rowsPerPage + (rowsPerPage - 1)}px;
                    margin: 0 auto;
                    background-color: #ddd;
                `;
                
                // 计算当前页的生字
                const startIndex = (page - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, currentCharacters.length);
                const pageCharacters = currentCharacters.slice(startIndex, endIndex);
                
                console.log(`第${page}页: 生字索引 ${startIndex}-${endIndex-1}, 生字数: ${pageCharacters.length}`);
                
                // 生成所有格子（10行 × 8列 = 80个格子）
                for (let i = 0; i < rowsPerPage * colsPerRow; i++) {
                    const row = Math.floor(i / colsPerRow);
                    const col = i % colsPerRow;
                    const hasCharacter = row < pageCharacters.length && col === 0;
                    const currentCharacter = hasCharacter ? pageCharacters[row] : '';
                    
                    const cellElement = document.createElement('div');
                    cellElement.className = 'grid-cell';
                    cellElement.style.cssText = `
                        position: relative;
                        border: none;
                        width: ${cellSize}px;
                        height: ${cellSize}px;
                        box-sizing: border-box;
                        background-color: white;
                        overflow: hidden;
                    `;
                    
                    // 添加方格线
                    const gridLines = document.createElement('div');
                    gridLines.className = 'grid-lines';
                    gridLines.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        pointer-events: none;
                    `;
                    
                    if (currentSettings.gridType === 'tian') {
                        gridLines.innerHTML = `
                            <div class="line center-vertical" style="position:absolute;width:1px;height:100%;left:50%;transform:translateX(-50%);background-color:#eee;"></div>
                            <div class="line center-horizontal" style="position:absolute;height:1px;width:100%;top:50%;transform:translateY(-50%);background-color:#eee;"></div>
                        `;
                    } else if (currentSettings.gridType === 'mi') {
                        gridLines.innerHTML = `
                            <div class="line center-vertical" style="position:absolute;width:1px;height:100%;left:50%;transform:translateX(-50%);background-color:#eee;"></div>
                            <div class="line center-horizontal" style="position:absolute;height:1px;width:100%;top:50%;transform:translateY(-50%);background-color:#eee;"></div>
                            <div class="line diagonal-1" style="position:absolute;width:1px;height:141%;left:50%;top:-20%;transform:translateX(-50%) rotate(45deg);background-color:#eee;"></div>
                            <div class="line diagonal-2" style="position:absolute;width:1px;height:141%;left:50%;top:-20%;transform:translateX(-50%) rotate(-45deg);background-color:#eee;"></div>
                        `;
                    }
                    
                    cellElement.appendChild(gridLines);
                        
                    // 如果是每行的第一个单元格且有生字，显示生字
                    if (hasCharacter) {
                        const characterElement = document.createElement('div');
                        characterElement.className = 'character';
                        characterElement.textContent = currentCharacter;
                        characterElement.style.cssText = `
                            font-family: ${currentSettings.fontFamily};
                            font-size: ${Math.min(currentSettings.fontSize, cellSize * 0.6)}px;
                            font-weight: ${currentSettings.fontWeight};
                            color: ${currentSettings.fontColor};
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            text-align: center;
                            z-index: 2;
                            width: 100%;
                            height: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        `;
                        
                        characterElement.dataset.index = startIndex + row;
                        characterElement.dataset.character = currentCharacter;
                        
                        cellElement.appendChild(characterElement);
                        cellElement.classList.remove('empty-cell');
                    } else {
                        cellElement.classList.add('empty-cell');
                        cellElement.style.backgroundColor = '#f9f9f9';
                    }
                    
                    gridContainer.appendChild(cellElement);
                }
                
                pageElement.appendChild(gridContainer);
                gridPagesContainer.appendChild(pageElement);
            }
            
            // 更新页面信息
            currentPage = 1;
            updatePageInfo();
            updatePageControls();
            
            // 更新统计信息
            characterCount.textContent = `共 ${currentCharacters.length} 个生字，${totalPages} 页，每页 ${rowsPerPage} 个生字`;
            
            // 启用下载按钮
            downloadWordBtn.disabled = false;
            
            console.log(`字帖生成完成: 总生字数 ${currentCharacters.length}, 总页数 ${totalPages}`);
            
            setTimeout(() => {
                hideLoading();
                showSuccess(`字帖生成成功！共 ${currentCharacters.length} 个生字，${totalPages} 页`);
            }, 500);
            
        } catch (error) {
            console.error('生成字帖时出错:', error);
            showError('生成字帖失败: ' + error.message);
            hideLoading();
        }
    }

    // 获取安全的文件名
    function getValidFileName(text) {
        if (!text) return '字帖';
        return text
            .replace(/[<>:"/\\|?*]/g, '_') // 移除非法字符
            .replace(/\s+/g, '_')           // 空格替换为下划线
            .replace(/[^\u4e00-\u9fa5a-zA-Z0-9_]/g, '') // 只保留中文、英文、数字和下划线
            .substring(0, 50) || '字帖';    // 限制长度
    }
   
    // 下载为Word文档 - 以图片形式，等比例适应A4纸
    async function downloadAsWord() {
        if (currentCharacters.length === 0) {
            showError('请先生成字帖');
            return;
        }
        
        showLoading();
        
        try {
            // 获取标题
            const title = previewTitle.textContent || '小学语文生字字帖';
            const date = new Date().toLocaleDateString('zh-CN');
            const fileName = getValidFileName(title) + '.doc';
            
            // 收集所有页面的图片数据
            const pageImages = [];
            
            console.log(`开始生成Word文档，共 ${totalPages} 页`);
            
            // 为每个页面生成图片
            for (let i = 1; i <= totalPages; i++) {
                const pageElement = document.getElementById(`page-${i}`);
                if (pageElement) {
                    try {
                        console.log(`正在生成第 ${i} 页图片...`);
                        
                        // 确保页面元素正确显示
                        pageElement.style.display = 'block';
                        pageElement.style.visibility = 'visible';
                        pageElement.style.opacity = '1';
                        pageElement.style.position = 'relative';
                        
                        // 等待DOM更新
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // 使用html2canvas将页面转换为高质量图片
                        const canvas = await html2canvas(pageElement, {
                            scale: 3, // 提高分辨率，确保清晰度
                            backgroundColor: '#ffffff',
                            useCORS: true,
                            logging: false,
                            allowTaint: true,
                            width: pageElement.offsetWidth,
                            height: pageElement.scrollHeight,
                            windowWidth: pageElement.scrollWidth,
                            windowHeight: pageElement.scrollHeight,
                            onclone: function(clonedDoc) {
                                // 确保克隆的页面也能正确显示
                                const clonedPage = clonedDoc.getElementById(`page-${i}`);
                                if (clonedPage) {
                                    clonedPage.style.display = 'block';
                                    clonedPage.style.visibility = 'visible';
                                    clonedPage.style.opacity = '1';
                                    clonedPage.style.position = 'relative';
                                }
                            }
                        });
                        
                        // 将canvas转换为base64图片
                        const imageData = canvas.toDataURL('image/png', 1.0);
                        pageImages.push({
                            data: imageData,
                            width: canvas.width,
                            height: canvas.height
                        });
                        
                        console.log(`第 ${i} 页图片生成成功，原始尺寸: ${canvas.width}x${canvas.height}`);
                        
                    } catch (error) {
                        console.error(`第 ${i} 页图片生成失败:`, error);
                        throw new Error(`第 ${i} 页转换为图片失败: ${error.message}`);
                    }
                } else {
                    console.error(`找不到第 ${i} 页元素`);
                    throw new Error(`找不到第 ${i} 页元素`);
                }
            }
            
            if (pageImages.length === 0) {
                throw new Error('未能生成任何页面图片');
            }
            
            console.log(`成功生成 ${pageImages.length} 页图片，开始创建Word文档`);
            
            // 创建Word文档
            let wordHTML = `
                <!DOCTYPE html>
                <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                      xmlns:w="urn:schemas-microsoft-com:office:word" 
                      xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <title>${title}</title>
                    <style>
                        body {
                            font-family: 'Microsoft YaHei', 'SimSun', sans-serif;
                            margin: 0;
                            padding: 0;
                        }
                        .page-break {
                            page-break-after: always;
                        }
                        .word-page {
                            width: 21cm;
                            min-height: 29.7cm;
                            margin: 0 auto;
                            padding: 2cm;
                            box-sizing: border-box;
                            page-break-inside: avoid;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 1cm;
                            padding-bottom: 0.5cm;
                            border-bottom: 2px solid #4a6fa5;
                        }
                        .title {
                            color: #4a6fa5;
                            font-size: 24pt;
                            margin: 0 0 0.2cm 0;
                            font-weight: bold;
                        }
                        .subtitle {
                            color: #666666;
                            font-size: 12pt;
                            margin: 0.1cm 0;
                        }
                        .info {
                            color: #999999;
                            font-size: 10pt;
                            margin: 0.1cm 0;
                        }
                        .image-container {
                            text-align: center;
                            margin: 0.5cm auto;
                            width: 100%;
                        }
                        .copybook-image {
                            max-width: 100%;
                            height: auto;
                            border: 1px solid #eee;
                            display: block;
                            margin: 0 auto;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 1cm;
                            padding-top: 0.5cm;
                            border-top: 1px solid #eeeeee;
                            color: #888888;
                            font-size: 9pt;
                        }
                        @page {
                            size: A4 portrait;
                            margin: 2cm;
                        }
                        @media print {
                            .word-page {
                                page-break-after: always;
                            }
                        }
                    </style>
                </head>
                <body>
            `;
            
            // 为每个页面创建Word页面
            pageImages.forEach((imageInfo, index) => {
                const pageNumber = index + 1;
                wordHTML += `<div class="word-page ${index < pageImages.length - 1 ? 'page-break' : ''}">`;
                
                // 页眉
                wordHTML += `
                    <div class="header">
                        <h1 class="title">${title}</h1>
                        <p class="subtitle">规范书写练习 - 共 ${currentCharacters.length} 个生字</p>
                        <p class="info">第 ${pageNumber} 页 / 共 ${pageImages.length} 页 - 生成日期: ${date}</p>
                        <p class="info">${currentSettings.gridType === 'tian' ? '田字格' : '米字格'} - 字体: ${getFontFamilyName(currentSettings.fontFamily)} - 每页10个生字</p>
                    </div>
                `;
                
                // 嵌入图片 - 等比例适应A4纸
                const maxImageWidth = '17cm'; // A4纸宽度减去页边距
                wordHTML += `
                    <div class="image-container">
                        <img src="${imageInfo.data}" class="copybook-image" alt="字帖第${pageNumber}页" 
                             style="max-width: ${maxImageWidth}; height: auto;" />
                    </div>
                `;
                
                // 计算当前页的生字
                const startIndex = (pageNumber - 1) * currentSettings.rowsPerPage;
                const endIndex = Math.min(startIndex + currentSettings.rowsPerPage, currentCharacters.length);
                const pageCharacters = currentCharacters.slice(startIndex, endIndex);
                
                // 添加生字列表
                wordHTML += `
                    <div style="margin-top: 1cm; text-align: center;">
                        <p style="color: #4a6fa5; font-weight: bold;">本页生字 (${pageCharacters.length}个):</p>
                        <p style="font-size: 14pt; letter-spacing: 5px; line-height: 1.8;">${pageCharacters.join(' ')}</p>
                    </div>
                `;
                
                // 页脚
                wordHTML += `
                    <div class="footer">
                        <p>小学语文生字字帖生成系统 | ${currentSettings.gridType === 'tian' ? '田字格' : '米字格'}练习本</p>
                        <p>温馨提示：请打印后使用铅笔或钢笔在字帖上练习书写，每个生字建议练习5-10遍</p>
                    </div>
                `;
                
                wordHTML += `</div>`;
            });
            
            wordHTML += `
                </body>
                </html>
            `;
            
            // 创建Blob对象
            const blob = new Blob(
                ['\ufeff' + wordHTML], // 添加BOM确保中文编码正确
                { type: 'application/msword' }
            );
            
            // 使用FileSaver保存文件
            saveAs(blob, fileName);
            
            showSuccess(`Word文档下载成功！共 ${pageImages.length} 页，每页${currentSettings.rowsPerPage}个生字`);
            
        } catch (error) {
            console.error('Word导出失败:', error);
            showError('Word导出失败: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // 获取Word兼容的字体名称
    function getFontFamilyName(fontFamily) {
        const fontMap = {
            'Ma Shan Zheng, cursive': '毛笔字体',
            'KaiTi, serif': '楷体',
            'SimSun, serif': '宋体',
            'Microsoft YaHei, sans-serif': '微软雅黑'
        };
        return fontMap[fontFamily] || '楷体';
    }
    
    // 更新字帖预览
    function updateCopybookPreview() {
        if (currentCharacters.length === 0) return;
        
        // 更新所有页面的样式
        const pages = document.querySelectorAll('.grid-page');
        const characters = document.querySelectorAll('.character');
        
        // 更新方格类型
        pages.forEach(page => {
            const gridLines = page.querySelectorAll('.grid-lines');
            gridLines.forEach(lines => {
                lines.innerHTML = '';
                
                if (currentSettings.gridType === 'tian') {
                    lines.innerHTML = `
                        <div class="line center-vertical" style="position:absolute;width:1px;height:100%;left:50%;transform:translateX(-50%);background-color:#eee;"></div>
                        <div class="line center-horizontal" style="position:absolute;height:1px;width:100%;top:50%;transform:translateY(-50%);background-color:#eee;"></div>
                    `;
                } else if (currentSettings.gridType === 'mi') {
                    lines.innerHTML = `
                        <div class="line center-vertical" style="position:absolute;width:1px;height:100%;left:50%;transform:translateX(-50%);background-color:#eee;"></div>
                        <div class="line center-horizontal" style="position:absolute;height:1px;width:100%;top:50%;transform:translateY(-50%);background-color:#eee;"></div>
                        <div class="line diagonal-1" style="position:absolute;width:1px;height:141%;left:50%;top:-20%;transform:translateX(-50%) rotate(45deg);background-color:#eee;"></div>
                        <div class="line diagonal-2" style="position:absolute;width:1px;height:141%;left:50%;top:-20%;transform:translateX(-50%) rotate(-45deg);background-color:#eee;"></div>
                    `;
                }
            });
        });
        
        // 更新字体样式
        characters.forEach(char => {
            char.style.fontFamily = currentSettings.fontFamily;
            char.style.fontSize = `${currentSettings.fontSize}px`;
            char.style.fontWeight = currentSettings.fontWeight;
            char.style.color = currentSettings.fontColor;
        });
    }

    // 重置设置
    function resetSettings() {
        gradeSelect.value = '';
        excelFileInput.value = '';
        
        // 重置方格类型
        gridTypeOptions.forEach(opt => opt.classList.remove('active'));
        document.querySelector('.grid-type-option[data-type="tian"]').classList.add('active');
        currentSettings.gridType = 'tian';
        
        // 重置字体设置
        fontFamilySelect.value = 'Ma Shan Zheng, cursive';
        currentSettings.fontFamily = 'Ma Shan Zheng, cursive';
        
        fontSizeSlider.value = 36;
        currentSettings.fontSize = 36;
        fontSizeValue.textContent = '36px';
        
        fontWeightSlider.value = 400;
        currentSettings.fontWeight = 400;
        fontWeightValue.textContent = '400';
        
        // 重置颜色
        colorOptions.forEach(opt => opt.classList.remove('active'));
        document.querySelector('.color-option[data-color="#333333"]').classList.add('active');
        currentSettings.fontColor = '#333333';
        customColorInput.value = '#333333';
        
        // 清空预览
        currentCharacters = [];
        gridPagesContainer.innerHTML = '';
        previewTitle.textContent = '字帖预览';
        characterCount.textContent = '请先生成字帖';
        downloadWordBtn.disabled = true;
        
        updatePageInfo();
        updatePageControls();
        
        showSuccess('设置已重置');
    }

    // 页面导航
    function goToPrevPage() {
        if (currentPage > 1) {
            document.getElementById(`page-${currentPage}`).classList.remove('active');
            currentPage--;
            document.getElementById(`page-${currentPage}`).classList.add('active');
            updatePageInfo();
            updatePageControls();
        }
    }
    
    function goToNextPage() {
        if (currentPage < totalPages) {
            document.getElementById(`page-${currentPage}`).classList.remove('active');
            currentPage++;
            document.getElementById(`page-${currentPage}`).classList.add('active');
            updatePageInfo();
            updatePageControls();
        }
    }
    
    function updatePageInfo() {
        currentPageSpan.textContent = currentPage;
        totalPagesSpan.textContent = totalPages;
    }
    
    function updatePageControls() {
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
    }

    // 工具函数
    function showLoading() {
        loadingOverlay.style.display = 'flex';
    }
    
    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
    }
    
    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
    }
    
    function hideMessages() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
    }
    
    function clearExcelFile() {
        excelFileInput.value = '';
    }

    // 初始化
    function init() {
        initEventListeners();
        
        // 高亮当前页面导航
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            const linkPage = link.getAttribute('href');
            if (linkPage === currentPage || (currentPage === '' && linkPage === 'copybook.html')) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>