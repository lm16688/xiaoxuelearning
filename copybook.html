<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字帖生成系统</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 在现有script引用后面添加 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
<!-- 在现有的script引用后面添加 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<!-- 添加中文字体支持 -->
<script src="https://unpkg.com/jspdf-customfonts@latest/dist/default_vfs.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <style>
<!-- 在现有的CSS中添加以下样式 -->

/* 移动端触摸优化 */
@media (max-width: 768px) {
    button, 
    .action-btn, 
    .nav-link, 
    .grid-type-option,
    .color-option,
    .upload-input {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    
    /* 防止双击缩放 */
    button, .action-btn {
        touch-action: manipulation;
    }
    
    /* 优化滚动体验 */
    .settings-panel, .copybook-preview {
        -webkit-overflow-scrolling: touch;
    }
    
    /* 修复iOS Safari上的按钮样式 */
    input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
    }
    
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
    }
}
    /* 更新设置面板样式，使其可滚动 */
    .settings-panel {
        width: 320px;
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        height: 85vh; /* 设置固定高度 */
        overflow-y: auto; /* 添加垂直滚动 */
        position: sticky;
        top: 20px;
        scrollbar-width: thin;
        scrollbar-color: #4a6fa5 #f0f0f0;
    }

    /* 自定义滚动条样式 */
    .settings-panel::-webkit-scrollbar {
        width: 6px;
    }

    .settings-panel::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 3px;
    }

    .settings-panel::-webkit-scrollbar-thumb {
        background: #4a6fa5;
        border-radius: 3px;
    }

    .settings-panel::-webkit-scrollbar-thumb:hover {
        background: #3a5a8a;
    }

    /* 调整字帖预览区域 */
    .copybook-preview {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        max-height: 85vh; /* 与左侧面板高度一致 */
        overflow-y: auto; /* 如果内容过多也可滚动 */
    }

        /* 导航栏样式 */
        .navbar {
            background-color: #4a90e2;
            padding: 12px 0;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            font-size: 18px;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-link.active {
            background-color: #2c6cb0;
        }
        
        .nav-link i {
            margin-right: 8px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* 字帖页面专用样式 */
        .copybook-container {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        
        .settings-panel {
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .settings-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .settings-group h3 {
            color: #4a6fa5;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-group h3 i {
            font-size: 18px;
        }
        
        .grade-selection {
            margin-bottom: 20px;
        }
        
        .grade-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .grade-select:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        .upload-section {
            margin-top: 20px;
        }
        
        .upload-label {
            display: block;
            margin-bottom: 10px;
            color: #666;
            font-weight: 500;
        }
        
        .upload-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            margin-bottom: 10px;
        }
        
        .upload-input:hover {
            border-color: #4a6fa5;
        }
        
        .upload-input input {
            display: none;
        }
        
        .upload-help {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            display: block;
        }
        
        .grid-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .grid-type-option {
            text-align: center;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .grid-type-option:hover {
            border-color: #4a6fa5;
            background-color: #f0f7ff;
        }
        
        .grid-type-option.active {
            border-color: #4a6fa5;
            background-color: #4a6fa5;
            color: white;
        }
        
        .grid-type-preview {
            width: 40px;
            height: 40px;
            margin: 0 auto 8px;
            position: relative;
            border: 1px solid #999;
            border-radius: 2px;
        }
        
        .font-family-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .slider-container {
            margin-bottom: 15px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .slider-value {
            color: #4a6fa5;
            font-weight: bold;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4a6fa5;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.3s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.active {
            border-color: #333;
            transform: scale(1.1);
        }
        
        .custom-color {
            position: relative;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
            cursor: pointer;
        }
        
        .custom-color input {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .generate-btn {
            background-color: #4a6fa5;
            color: white;
        }
        
        .generate-btn:hover {
            background-color: #3a5a8a;
            transform: translateY(-2px);
        }
        
        .download-btn {
            background-color: #27ae60;
            color: white;
        }
        
        .download-btn:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }
        
        .reset-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .reset-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .copybook-preview {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .preview-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .preview-header h2 {
            color: #4a6fa5;
            margin-bottom: 5px;
        }
        
        .preview-header p {
            color: #666;
        }
        
        .preview-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .page-btn {
            background-color: #4a6fa5;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .page-btn:hover:not(:disabled) {
            background-color: #3a5a8a;
            transform: scale(1.1);
        }
        
        .page-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .page-info {
            font-weight: 500;
            color: #4a6fa5;
        }
        
        .copybook-content {
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .grid-page {
            display: none;
            width: 100%;
        }
        
        .grid-page.active {
            display: block;
        }
        
        .grid-row {
            display: flex;
            width: 100%;
        }
        
        .grid-cell {
            flex: 1;
            aspect-ratio: 1/1;
            position: relative;
            border: 1px solid #ddd;
        }
        
        .grid-cell:nth-child(odd) {
            border-right: 1px solid #ddd;
        }
        
        .grid-cell:last-child {
            border-right: 1px solid #ddd;
        }
        
        .grid-cell .grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .grid-cell .grid-lines .line {
            position: absolute;
            background-color: #eee;
        }
        
        .grid-cell .grid-lines .center-vertical {
            width: 1px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .grid-cell .grid-lines .center-horizontal {
            height: 1px;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .grid-cell .grid-lines .diagonal-1 {
            width: 1px;
            height: 141%;
            left: 50%;
            top: -20%;
            transform: translateX(-50%) rotate(45deg);
        }
        
        .grid-cell .grid-lines .diagonal-2 {
            width: 1px;
            height: 141%;
            left: 50%;
            top: -20%;
            transform: translateX(-50%) rotate(-45deg);
        }
        
        .grid-cell .character {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2;
        }
        
        .empty-cell {
            background-color: #f9f9f9;
        }
        
        .preview-footer {
            text-align: center;
            margin-top: 20px;
            color: #888;
            font-size: 14px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        .loading-spinner i {
            font-size: 48px;
            color: #4a6fa5;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        @media (max-width: 1024px) {
            .copybook-container {
                flex-direction: column;
            }
            
            .settings-panel {
                width: 100%;
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .grid-type-selector {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }


        
        
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>主页
                </a>
                <a href="copybook.html" class="nav-link active">
                    <i class="fas fa-pen-fancy"></i>字帖练习
                </a>
            </div>
        </nav>
        
        <header class="header">
            <h1>小学语文生字字帖生成系统</h1>
            <p class="subtitle">生成专业田字格/米字格字帖，支持打印和导出</p>
        </header>
        
        <!-- 错误和成功消息 -->
        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>
        
        <div class="copybook-container">
            <!-- 左侧设置面板 -->
            <div class="settings-panel">
                <div class="settings-group">
                    <h3><i class="fas fa-book"></i> 生字来源</h3>
                    
                    <div class="grade-selection">
                        <label>选择年级：</label>
                        <select id="grade-select" class="grade-select">
                            <option value="">请选择年级</option>
                            <option value="一年级上册">一年级上册</option>
                            <option value="一年级下册">一年级下册</option>
                            <option value="二年级上册">二年级上册</option>
                            <option value="二年级下册">二年级下册</option>
                            <option value="三年级上册">三年级上册</option>
                            <option value="三年级下册">三年级下册</option>
                            <option value="四年级上册">四年级上册</option>
                            <option value="四年级下册">四年级下册</option>
                            <option value="五年级上册">五年级上册</option>
                            <option value="五年级下册">五年级下册</option>
                            <option value="六年级上册">六年级上册</option>
                            <option value="六年级下册">六年级下册</option>
                        </select>
                    </div>
                    
                    <div class="upload-section">
                        <label class="upload-label">或上传Excel文件：</label>
                        <div class="upload-input" id="excel-upload">
                            <i class="fas fa-upload"></i>
                            <span>点击上传Excel文件</span>
                            <input type="file" id="excel-file" accept=".xlsx,.xls,.csv">
                        </div>
                        <small class="upload-help">Excel文件必须包含"生字"列</small>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-border-style"></i> 方格设置</h3>
                    <div class="grid-type-selector">
                        <div class="grid-type-option active" data-type="tian">
                            <div class="grid-type-preview">
                                <div class="grid-lines">
                                    <div class="line center-vertical"></div>
                                    <div class="line center-horizontal"></div>
                                </div>
                            </div>
                            <div>田字格</div>
                        </div>
                        <div class="grid-type-option" data-type="mi">
                            <div class="grid-type-preview">
                                <div class="grid-lines">
                                    <div class="line center-vertical"></div>
                                    <div class="line center-horizontal"></div>
                                    <div class="line diagonal-1"></div>
                                    <div class="line diagonal-2"></div>
                                </div>
                            </div>
                            <div>米字格</div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-font"></i> 字体设置</h3>
                    
                    <label>字体类型：</label>
                    <select id="font-family" class="font-family-select">
                        <option value="Ma Shan Zheng, cursive">毛笔字体</option>
                        <option value="KaiTi, serif">楷体</option>
                        <option value="SimSun, serif">宋体</option>
                        <option value="Microsoft YaHei, sans-serif">微软雅黑</option>
                    </select>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>字体大小：</span>
                            <span id="font-size-value" class="slider-value">36px</span>
                        </div>
                        <input type="range" id="font-size" class="slider" min="20" max="60" value="36">
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>字体粗细：</span>
                            <span id="font-weight-value" class="slider-value">400</span>
                        </div>
                        <input type="range" id="font-weight" class="slider" min="100" max="900" step="100" value="400">
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-palette"></i> 字体颜色</h3>
                    <div class="color-picker">
                        <div class="color-option active" style="background-color: #333333;" data-color="#333333"></div>
                        <div class="color-option" style="background-color: #4a6fa5;" data-color="#4a6fa5"></div>
                        <div class="color-option" style="background-color: #27ae60;" data-color="#27ae60"></div>
                        <div class="color-option" style="background-color: #e74c3c;" data-color="#e74c3c"></div>
                        <div class="color-option" style="background-color: #f39c12;" data-color="#f39c12"></div>
                        <div class="color-option" style="background-color: #8e44ad;" data-color="#8e44ad"></div>
                        <div class="color-option custom-color">
                            <input type="color" id="custom-color" value="#333333">
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="generate-btn" class="action-btn generate-btn">
                        <i class="fas fa-magic"></i> 生成字帖
                    </button>
                    <button id="download-pdf-btn" class="action-btn download-btn" disabled>
                        <i class="fas fa-file-pdf"></i> 下载PDF
                    </button>
                    <button id="reset-btn" class="action-btn reset-btn">
                        <i class="fas fa-redo"></i> 重置设置
                    </button>
                </div>
            </div>
            
            <!-- 右侧字帖预览 -->
            <div class="copybook-preview">
                <div class="preview-header">
                    <h2 id="preview-title">字帖预览</h2>
                    <p id="character-count">请先生成字帖</p>
                </div>
                
                <div class="preview-controls">
                    <button id="prev-page-btn" class="page-btn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="page-info" class="page-info">第 <span id="current-page">1</span> 页 / 共 <span id="total-pages">1</span> 页</span>
                    <button id="next-page-btn" class="page-btn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <div id="copybook-content" class="copybook-content">
                    <div id="grid-pages">
                        <!-- 字帖页面会在这里动态生成 -->
                        <div class="grid-page active" id="page-1">
                            <!-- 网格行会在这里动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="preview-footer">
                    <p>温馨提示：生成字帖后，您可以直接打印或下载为PDF文件</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 加载动画 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner"></i>
            <p>正在生成字帖，请稍候...</p>
        </div>
    </div>
    
    <script>
    // 全局变量
    let currentCharacters = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentSettings = {
        gridType: 'tian',
        fontFamily: 'Ma Shan Zheng, cursive',
        fontSize: 36,
        fontWeight: 400,
        fontColor: '#333333',
        rowsPerPage: 10,  // 每页10行
        colsPerPage: 8    // 每行8个格子
    };

    // DOM元素
    const gradeSelect = document.getElementById('grade-select');
    const excelUpload = document.getElementById('excel-upload');
    const excelFileInput = document.getElementById('excel-file');
    const gridTypeOptions = document.querySelectorAll('.grid-type-option');
    const fontFamilySelect = document.getElementById('font-family');
    const fontSizeSlider = document.getElementById('font-size');
    const fontSizeValue = document.getElementById('font-size-value');
    const fontWeightSlider = document.getElementById('font-weight');
    const fontWeightValue = document.getElementById('font-weight-value');
    const colorOptions = document.querySelectorAll('.color-option:not(.custom-color)');
    const customColorInput = document.getElementById('custom-color');
    const generateBtn = document.getElementById('generate-btn');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');
    const resetBtn = document.getElementById('reset-btn');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    const currentPageSpan = document.getElementById('current-page');
    const totalPagesSpan = document.getElementById('total-pages');
    const gridPagesContainer = document.getElementById('grid-pages');
    const previewTitle = document.getElementById('preview-title');
    const characterCount = document.getElementById('character-count');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    // 初始化事件监听器
    function initEventListeners() {
        // 年级选择
        gradeSelect.addEventListener('change', function() {
            if (this.value) {
                clearExcelFile();
                loadCharactersFromJSON(this.value);
            }
        });
        
        // Excel文件上传
        excelUpload.addEventListener('click', function() {
            excelFileInput.click();
        });
        
        excelFileInput.addEventListener('change', function(e) {
            if (this.files.length > 0) {
                gradeSelect.value = '';
                loadCharactersFromExcel(this.files[0]);
            }
        });
        
        // 方格类型选择
        gridTypeOptions.forEach(option => {
            option.addEventListener('click', function() {
                gridTypeOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                currentSettings.gridType = this.dataset.type;
                updateCopybookPreview();
            });
        });
        
        // 字体设置
        fontFamilySelect.addEventListener('change', function() {
            currentSettings.fontFamily = this.value;
            updateCopybookPreview();
        });
        
        fontSizeSlider.addEventListener('input', function() {
            currentSettings.fontSize = parseInt(this.value);
            fontSizeValue.textContent = this.value + 'px';
            updateCopybookPreview();
        });
        
        fontWeightSlider.addEventListener('input', function() {
            currentSettings.fontWeight = parseInt(this.value);
            fontWeightValue.textContent = this.value;
            updateCopybookPreview();
        });
        
        // 颜色选择
        colorOptions.forEach(option => {
            option.addEventListener('click', function() {
                colorOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                currentSettings.fontColor = this.dataset.color;
                customColorInput.value = this.dataset.color;
                updateCopybookPreview();
            });
        });
        
        customColorInput.addEventListener('input', function() {
            currentSettings.fontColor = this.value;
            colorOptions.forEach(opt => opt.classList.remove('active'));
            updateCopybookPreview();
        });
        
        // 按钮事件
        generateBtn.addEventListener('click', generateCopybook);
        downloadPdfBtn.addEventListener('click', downloadAsPDF);
        resetBtn.addEventListener('click', resetSettings);
        prevPageBtn.addEventListener('click', goToPrevPage);
        nextPageBtn.addEventListener('click', goToNextPage);
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                goToPrevPage();
            } else if (e.key === 'ArrowRight') {
                goToNextPage();
            } else if (e.key === 'Enter' && e.ctrlKey) {
                generateCopybook();
            }
        });
    }

    // 从JSON加载生字数据
    async function loadCharactersFromJSON(grade) {
        showLoading();
        hideMessages();
        
        try {
            const response = await fetch('data.json');
            if (!response.ok) throw new Error('数据加载失败');
            
            const data = await response.json();
            const gradeData = data.find(item => item.grade === grade);
            
            if (gradeData && gradeData.characters) {
                // 确保读取所有生字
                currentCharacters = gradeData.characters.map(item => item.word);
                
                // 去重并过滤空值
                currentCharacters = [...new Set(currentCharacters.filter(char => char && char.trim()))];
                
                previewTitle.textContent = `${grade} 生字字帖`;
                showSuccess(`成功加载 ${currentCharacters.length} 个生字！`);
                
                // 检查实际读取的生字
                console.log(`从JSON读取的生字数量: ${currentCharacters.length}`);
                console.log('前10个生字:', currentCharacters.slice(0, 10));
                
                setTimeout(() => {
                    generateCopybook();
                }, 100);
            } else {
                throw new Error(`未找到${grade}的生字数据`);
            }
        } catch (error) {
            showError(error.message);
            currentCharacters = [];
        } finally {
            hideLoading();
        }
    }

    // 从Excel加载生字数据 - 修复版本
    async function loadCharactersFromExcel(file) {
        showLoading();
        hideMessages();
        
        try {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    console.log('Excel原始数据:', jsonData);
                    
                    // 查找"生字"列索引
                    let characterColumnIndex = -1;
                    const headers = jsonData[0] || [];
                    
                    for (let i = 0; i < headers.length; i++) {
                        const header = String(headers[i]).trim().toLowerCase();
                        if (header === '生字' || header === 'word' || header === '汉字' || header === '字符') {
                            characterColumnIndex = i;
                            break;
                        }
                    }
                    
                    if (characterColumnIndex === -1) {
                        // 尝试自动识别第一列
                        characterColumnIndex = 0;
                    }
                    
                    // 从第二行开始读取数据（跳过标题行）
                    let characters = [];
                    for (let rowIndex = 1; rowIndex < jsonData.length; rowIndex++) {
                        const row = jsonData[rowIndex] || [];
                        if (row[characterColumnIndex]) {
                            const char = String(row[characterColumnIndex]).trim();
                            if (char) {
                                characters.push(char);
                            }
                        }
                    }
                    
                    if (characters.length === 0) {
                        // 尝试另一种读取方式
                        const jsonData2 = XLSX.utils.sheet_to_json(firstSheet);
                        characters = [];
                        
                        for (let row of jsonData2) {
                            // 尝试所有可能的列名
                            for (let key in row) {
                                const value = String(row[key]).trim();
                                if (value && value.length <= 3) { // 生字通常是1-3个字符
                                    characters.push(value);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (characters.length === 0) {
                        throw new Error('无法从Excel文件中读取生字数据，请确保文件包含生字内容');
                    }
                    
                    // 去重并过滤空值
                    characters = [...new Set(characters.filter(char => char && char.trim()))];
                    
                    currentCharacters = characters;
                    previewTitle.textContent = `自定义生字字帖 (${file.name})`;
                    showSuccess(`成功读取 ${characters.length} 个生字`);
                    
                    console.log(`从Excel读取的生字数量: ${characters.length}`);
                    console.log('前10个生字:', characters.slice(0, 10));
                    
                    setTimeout(() => {
                        generateCopybook();
                    }, 100);
                    
                } catch (error) {
                    console.error('Excel处理错误:', error);
                    showError('Excel文件处理失败: ' + error.message);
                    currentCharacters = [];
                } finally {
                    hideLoading();
                }
            };
            
            reader.onerror = function() {
                showError('文件读取失败');
                hideLoading();
            };
            
            reader.readAsArrayBuffer(file);
        } catch (error) {
            console.error('文件读取错误:', error);
            showError('文件处理失败: ' + error.message);
            hideLoading();
        }
    }

    // 生成字帖 - 修复版本，确保所有生字都被生成
    function generateCopybook() {
        if (currentCharacters.length === 0) {
            showError('请先选择年级或上传Excel文件');
            return;
        }
        
        console.log(`开始生成字帖，总生字数: ${currentCharacters.length}`);
        console.log('前20个生字:', currentCharacters.slice(0, 20));
        
        showLoading();
        
        try {
            // 计算总页数 - 每行8个格子，每页10行
            const charactersPerRow = currentSettings.colsPerPage; // 每行8个字
            const rowsPerPage = currentSettings.rowsPerPage; // 每页10行
            const charactersPerPage = rowsPerPage * 1; // 每页显示的生字数 = 行数 * 1（每行第一个格子）
            
            // 注意：我们只在每行的第一个格子显示生字，所以每页实际显示的生字数 = 行数
            totalPages = Math.ceil(currentCharacters.length / rowsPerPage);
            
            console.log(`字帖配置: 每页${rowsPerPage}行, 每行${charactersPerRow}格, 总页数: ${totalPages}`);
            console.log(`每页显示生字数: ${rowsPerPage}个`);
            
            // 清空现有页面
            gridPagesContainer.innerHTML = '';
            
            // 生成所有页面
            for (let page = 1; page <= totalPages; page++) {
                const pageElement = document.createElement('div');
                pageElement.className = `grid-page ${page === 1 ? 'active' : ''}`;
                pageElement.id = `page-${page}`;
                
                // 计算当前页的生字
                const startIndex = (page - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, currentCharacters.length);
                const pageCharacters = currentCharacters.slice(startIndex, endIndex);
                
                console.log(`第${page}页: 生字索引 ${startIndex}-${endIndex-1}, 生字数: ${pageCharacters.length}`);
                
                // 为当前页的每个生字生成一行
                for (let row = 0; row < rowsPerPage; row++) {
                    const rowElement = document.createElement('div');
                    rowElement.className = 'grid-row';
                    
                    // 当前行是否有生字
                    const hasCharacter = row < pageCharacters.length;
                    const currentCharacter = hasCharacter ? pageCharacters[row] : '';
                    
                    // 生成8个格子
                    for (let col = 0; col < charactersPerRow; col++) {
                        const cellElement = document.createElement('div');
                        cellElement.className = 'grid-cell';
                        
                        // 添加方格线
                        const gridLines = document.createElement('div');
                        gridLines.className = 'grid-lines';
                        
                        if (currentSettings.gridType === 'tian') {
                            gridLines.innerHTML = `
                                <div class="line center-vertical"></div>
                                <div class="line center-horizontal"></div>
                            `;
                        } else if (currentSettings.gridType === 'mi') {
                            gridLines.innerHTML = `
                                <div class="line center-vertical"></div>
                                <div class="line center-horizontal"></div>
                                <div class="line diagonal-1"></div>
                                <div class="line diagonal-2"></div>
                            `;
                        }
                        
                        cellElement.appendChild(gridLines);
                        
                        // 如果是第一个单元格且有生字，显示生字
                        if (col === 0 && hasCharacter) {
                            const characterElement = document.createElement('div');
                            characterElement.className = 'character';
                            characterElement.textContent = currentCharacter;
                            characterElement.style.fontFamily = currentSettings.fontFamily;
                            characterElement.style.fontSize = `${currentSettings.fontSize}px`;
                            characterElement.style.fontWeight = currentSettings.fontWeight;
                            characterElement.style.color = currentSettings.fontColor;
                            
                            // 添加调试信息
                            characterElement.dataset.index = startIndex + row;
                            
                            cellElement.appendChild(characterElement);
                            
                            // 移除空单元格类
                            cellElement.classList.remove('empty-cell');
                        } else {
                            // 其他格子为空
                            cellElement.classList.add('empty-cell');
                        }
                        
                        rowElement.appendChild(cellElement);
                    }
                    
                    pageElement.appendChild(rowElement);
                }
                
                gridPagesContainer.appendChild(pageElement);
            }
            
            // 更新页面信息
            currentPage = 1;
            updatePageInfo();
            updatePageControls();
            
            // 更新统计信息
            const totalCharactersDisplayed = Math.min(currentCharacters.length, rowsPerPage * totalPages);
            characterCount.textContent = `共 ${currentCharacters.length} 个生字，${totalPages} 页，每页 ${rowsPerPage} 个生字`;
            
            // 启用下载按钮
            downloadPdfBtn.disabled = false;
            
            console.log(`字帖生成完成: 总生字数 ${currentCharacters.length}, 总页数 ${totalPages}`);
            
            setTimeout(() => {
                hideLoading();
                showSuccess(`字帖生成成功！共 ${currentCharacters.length} 个生字，${totalPages} 页`);
            }, 500);
            
        } catch (error) {
            console.error('生成字帖时出错:', error);
            showError('生成字帖失败: ' + error.message);
            hideLoading();
        }
    }


// 优化PDF布局的函数
function optimizeForPDF() {
    // 1. 获取PDF页面尺寸 (A4尺寸)
    const pdfWidth = 794; // A4在96dpi下的像素宽度 (210mm)
    const pdfHeight = 1123; // A4高度 (297mm)
    
    // 2. 调整内容容器尺寸
    const content = document.getElementById('copybook-content');
    if (!content) return;
    
    content.style.width = pdfWidth + 'px';
    content.style.maxWidth = '100%';
    content.style.overflow = 'hidden';
    content.style.margin = '0 auto';
    
    // 3. 调整网格页面尺寸
    const gridPages = content.querySelectorAll('.grid-page');
    gridPages.forEach(page => {
        page.style.width = pdfWidth + 'px';
        page.style.minHeight = pdfHeight + 'px';
        page.style.boxSizing = 'border-box';
        page.style.padding = '20px';
        
        // 确保8列网格正确显示
        const gridRows = page.querySelectorAll('.grid-row');
        gridRows.forEach(row => {
            row.style.display = 'flex';
            row.style.width = '100%';
            
            // 计算每个格子的宽度
            const cellWidth = (pdfWidth - 40) / 8; // 减去padding
            const gridCells = row.querySelectorAll('.grid-cell');
            gridCells.forEach(cell => {
                cell.style.width = cellWidth + 'px';
                cell.style.height = cellWidth + 'px'; // 保持正方形
                cell.style.flexShrink = '0';
            });
        });
    });
    
    // 4. 添加分页符
    let currentHeight = 0;
    gridPages.forEach((page, index) => {
        const pageHeight = page.offsetHeight;
        
        if (index > 0) {
            page.style.pageBreakBefore = 'always';
        }
        
        // 确保每页高度不超过A4高度
        if (pageHeight > pdfHeight) {
            page.style.height = pdfHeight + 'px';
            page.style.overflow = 'hidden';
        }
    });
}

// 恢复原始布局
function restoreOriginalLayout() {
    const content = document.getElementById('copybook-content');
    if (!content) return;
    
    // 移除PDF优化样式
    content.style.width = '';
    content.style.maxWidth = '';
    content.style.overflow = '';
    content.style.margin = '';
    
    // 恢复网格页面样式
    const gridPages = content.querySelectorAll('.grid-page');
    gridPages.forEach(page => {
        page.style.width = '';
        page.style.minHeight = '';
        page.style.boxSizing = '';
        page.style.padding = '';
        page.style.pageBreakBefore = '';
        page.style.height = '';
        page.style.overflow = '';
        
        // 恢复网格行样式
        const gridRows = page.querySelectorAll('.grid-row');
        gridRows.forEach(row => {
            row.style.display = '';
            row.style.width = '';
            
            // 恢复单元格样式
            const gridCells = row.querySelectorAll('.grid-cell');
            gridCells.forEach(cell => {
                cell.style.width = '';
                cell.style.height = '';
                cell.style.flexShrink = '';
            });
        });
    });
}


        
    // 下载为PDF - 修复中文乱码问题
// 在 downloadAsPDF 函数之前添加这个辅助函数
function getValidFileName(text) {
    if (!text) return '字帖';
    return text
        .replace(/[<>:"/\\|?*]/g, '_') // 移除非法字符
        .replace(/\s+/g, '_')           // 空格替换为下划线
        .replace(/[^\u4e00-\u9fa5a-zA-Z0-9_]/g, '') // 只保留中文、英文、数字和下划线
        .substring(0, 50) || '字帖';    // 限制长度
}
   
// 下载为PDF - 使用中文字体支持
// 下载为PDF - 使用html2pdf库（支持中文）
// 下载为PDF - 使用布局优化
async function downloadAsPDF() {
    if (currentCharacters.length === 0) {
        showError('请先生成字帖');
        return;
    }
    
    showLoading();
    
    try {
        // 切换到PDF优化模式
        await switchToPDFMode();
        
        // 获取字帖内容
        const copybookContent = document.getElementById('copybook-content');
        
        // 隐藏不需要的元素
        const hideSelectors = [
            '.preview-controls',
            '.preview-footer',
            '.navbar',
            '.header',
            '.settings-panel',
            '.preview-header'
        ];
        
        const originalStyles = [];
        hideSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                originalStyles.push({
                    element: el,
                    display: el.style.display
                });
                el.style.display = 'none';
            });
        });
        
        // 显示所有页面
        const allPages = document.querySelectorAll('.grid-page');
        allPages.forEach(page => page.style.display = 'block');
        
        // 优化PDF布局
        optimizeForPDF();
        
        // 等待布局调整完成
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 配置html2pdf
        const opt = {
            margin: [0, 0, 0, 0], // 无边距，内容已包含边距
            filename: getValidFileName(previewTitle.textContent) + '.pdf',
            image: { 
                type: 'jpeg', 
                quality: 0.95 
            },
            html2canvas: { 
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                width: 794, // A4宽度
                windowWidth: 794,
                scrollX: 0,
                scrollY: 0,
                letterRendering: true,
                allowTaint: true,
                useCORS: true
            },
            jsPDF: { 
                unit: 'mm',
                format: 'a4',
                orientation: 'portrait',
                compress: true
            },
            pagebreak: {
                mode: ['css', 'legacy']
            }
        };
        
        // 生成PDF
        await html2pdf()
            .set(opt)
            .from(copybookContent)
            .toPdf()
            .get('pdf')
            .then((pdf) => {
                // 确保正确的页面尺寸
                const totalPages = pdf.internal.getNumberOfPages();
                console.log(`PDF共${totalPages}页`);
                
                // 保存PDF
                pdf.save(getValidFileName(previewTitle.textContent) + '.pdf');
            });
        
        // 恢复原始状态
        hideSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                el.style.display = 'block';
            });
        });
        
        originalStyles.forEach(item => {
            if (item.element) {
                item.element.style.display = item.display;
            }
        });
        
        // 恢复页面显示
        allPages.forEach((page, index) => {
            page.style.display = index === (currentPage - 1) ? 'block' : 'none';
        });
        
        // 恢复原始布局
        restoreOriginalLayout();
        
        showSuccess(`PDF下载成功！`);
        
    } catch (error) {
        console.error('PDF生成失败:', error);
        
        // 恢复原始布局以防万一
        restoreOriginalLayout();
        
        // 尝试备用方案
        try {
            await downloadPDFFallback();
        } catch (fallbackError) {
            showError('PDF生成失败，请尝试：\n1. 按Ctrl+P使用浏览器打印功能\n2. 截图保存');
        }
    } finally {
        hideLoading();
    }
}

// 备用PDF生成方案
async function downloadPDFFallback() {
    showLoading();
    
    try {
        // 切换到PDF模式
        switchToPDFMode();
        
        // 显示所有页面
        const allPages = document.querySelectorAll('.grid-page');
        allPages.forEach(page => page.style.display = 'block');
        
        // 分别处理每页
        for (let i = 0; i < allPages.length; i++) {
            const page = allPages[i];
            
            // 只显示当前页
            allPages.forEach((p, index) => {
                p.style.display = index === i ? 'block' : 'none';
            });
            
            const canvas = await html2canvas(page, {
                scale: 2,
                backgroundColor: '#ffffff',
                width: 794,
                height: 1123,
                useCORS: true
            });
            
            const { jsPDF } = window.jspdf;
            const pdf = i === 0 ? new jsPDF() : window.currentPDF;
            
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // 计算图片尺寸使其居中
            const imgWidth = pageWidth;
            const imgHeight = pageHeight;
            
            pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
            
            if (i < allPages.length - 1) {
                pdf.addPage();
            }
            
            window.currentPDF = pdf;
        }
        
        // 保存PDF
        window.currentPDF.save(getValidFileName(previewTitle.textContent) + '.pdf');
        delete window.currentPDF;
        
    } finally {
        // 恢复原始布局
        restoreOriginalLayout();
        
        // 恢复页面显示
        const allPages = document.querySelectorAll('.grid-page');
        allPages.forEach((page, index) => {
            page.style.display = index === (currentPage - 1) ? 'block' : 'none';
        });
        
        hideLoading();
    }
}

// 切换到PDF模式
async function switchToPDFMode() {
    document.body.classList.add('pdf-mode');
    
    // 应用PDF优化样式
    const content = document.getElementById('copybook-content');
    content.style.width = '794px';
    content.style.margin = '0 auto';
    
    return new Promise(resolve => {
        // 等待样式应用
        setTimeout(resolve, 100);
    });
}


        

        
    // 辅助函数：将十六进制颜色转换为RGB
    function hexToRgb(hex) {
        // 移除#号
        hex = hex.replace('#', '');
        
        // 解析RGB值
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        
        return { r, g, b };
    }

    // 更新字帖预览
    function updateCopybookPreview() {
        if (currentCharacters.length === 0) return;
        
        // 更新所有页面的样式
        const pages = document.querySelectorAll('.grid-page');
        const characters = document.querySelectorAll('.character');
        
        // 更新方格类型
        pages.forEach(page => {
            const gridLines = page.querySelectorAll('.grid-lines');
            gridLines.forEach(lines => {
                lines.innerHTML = '';
                
                if (currentSettings.gridType === 'tian') {
                    lines.innerHTML = `
                        <div class="line center-vertical"></div>
                        <div class="line center-horizontal"></div>
                    `;
                } else if (currentSettings.gridType === 'mi') {
                    lines.innerHTML = `
                        <div class="line center-vertical"></div>
                        <div class="line center-horizontal"></div>
                        <div class="line diagonal-1"></div>
                        <div class="line diagonal-2"></div>
                    `;
                }
            });
        });
        
        // 更新字体样式
        characters.forEach(char => {
            char.style.fontFamily = currentSettings.fontFamily;
            char.style.fontSize = `${currentSettings.fontSize}px`;
            char.style.fontWeight = currentSettings.fontWeight;
            char.style.color = currentSettings.fontColor;
        });
    }

    // 重置设置
    function resetSettings() {
        gradeSelect.value = '';
        excelFileInput.value = '';
        
        // 重置方格类型
        gridTypeOptions.forEach(opt => opt.classList.remove('active'));
        document.querySelector('.grid-type-option[data-type="tian"]').classList.add('active');
        currentSettings.gridType = 'tian';
        
        // 重置字体设置
        fontFamilySelect.value = 'Ma Shan Zheng, cursive';
        currentSettings.fontFamily = 'Ma Shan Zheng, cursive';
        
        fontSizeSlider.value = 36;
        currentSettings.fontSize = 36;
        fontSizeValue.textContent = '36px';
        
        fontWeightSlider.value = 400;
        currentSettings.fontWeight = 400;
        fontWeightValue.textContent = '400';
        
        // 重置颜色
        colorOptions.forEach(opt => opt.classList.remove('active'));
        document.querySelector('.color-option[data-color="#333333"]').classList.add('active');
        currentSettings.fontColor = '#333333';
        customColorInput.value = '#333333';
        
        // 清空预览
        currentCharacters = [];
        gridPagesContainer.innerHTML = '';
        previewTitle.textContent = '字帖预览';
        characterCount.textContent = '请先生成字帖';
        downloadPdfBtn.disabled = true;
        
        updatePageInfo();
        updatePageControls();
        
        showSuccess('设置已重置');
    }

    // 页面导航
    function goToPrevPage() {
        if (currentPage > 1) {
            document.getElementById(`page-${currentPage}`).classList.remove('active');
            currentPage--;
            document.getElementById(`page-${currentPage}`).classList.add('active');
            updatePageInfo();
            updatePageControls();
        }
    }
    
    function goToNextPage() {
        if (currentPage < totalPages) {
            document.getElementById(`page-${currentPage}`).classList.remove('active');
            currentPage++;
            document.getElementById(`page-${currentPage}`).classList.add('active');
            updatePageInfo();
            updatePageControls();
        }
    }
    
    function updatePageInfo() {
        currentPageSpan.textContent = currentPage;
        totalPagesSpan.textContent = totalPages;
    }
    
    function updatePageControls() {
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
    }

    // 工具函数
    function showLoading() {
        loadingOverlay.style.display = 'flex';
    }
    
    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
    }
    
    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
    }
    
    function hideMessages() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
    }
    
    function clearExcelFile() {
        excelFileInput.value = '';
    }

    // 初始化
    function init() {
        initEventListeners();
        
        // 高亮当前页面导航
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            const linkPage = link.getAttribute('href');
            if (linkPage === currentPage || (currentPage === '' && linkPage === 'copybook.html')) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
</script>

        
</body>
</html>
